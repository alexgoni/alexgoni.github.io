---
layout: single
title: "Suspenseë¥¼ ì“°ëŠ” ê²ƒì´ í•­ìƒ ì˜³ì„ê¹Œ?"
categories: React
---

## ğŸ” Suspense ë™ì‘ ì›ë¦¬

### Before React 18

ì£¼ë¡œ `lazy`ì™€ í•¨ê»˜ ì‚¬ìš©ë˜ë©°, ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…ì— ì‚¬ìš©ë˜ì—ˆë‹¤.  
ë‚˜ë‰œ ë²ˆë“¤ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ë™ì•ˆ Suspenseì˜ fallback UIë¥¼ í‘œì‹œí•˜ë„ë¡ ë™ì‘í•˜ì˜€ë‹¤.

### After React 18

18 ë²„ì „ ì´í›„ë¡œëŠ” ì´ëŸ¬í•œ ê¸°ëŠ¥ì´ data fetchingì—ë„ í™•ëŒ€ ì ìš©ë˜ì—ˆë‹¤.  
APIì˜ ê²°ê³¼ê°’ì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ fallback UIë¥¼ ì§€ì •í•´ì„œ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ê°€ëŠ¥í•´ì¡Œë‹¤.

ì´ë¥¼ ìœ„í•´ì„œëŠ” Suspenseê°€ ë¹„ë™ê¸°ë¥¼ ê°ì§€í•´ì•¼ í•˜ëŠ”ë°,  
ì´ëŠ” í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ì—ì„œ **Promiseë¥¼ throwí•˜ëŠ” ê²ƒìœ¼ë¡œ êµ¬í˜„ëœë‹¤.**

ì½”ë“œë¥¼ í†µí•´ í™•ì¸í•´ë³´ì.

```js
// fetchData.js

function wrapPromise(promise) {
  let status = "pending";
  let response;

  const suspender = promise.then(
    (res) => {
      // ì „ë‹¬ë°›ì€ Promiseì˜ ìƒíƒœê°€ settled ë˜ì—ˆì„ ë•Œ
      status = "success";
      response = res;
    },
    (err) => {
      // ì „ë‹¬ë°›ì€ Promiseì˜ ìƒíƒœê°€ reject ë˜ì—ˆì„ ë•Œ
      status = "error";
      response = err;
    }
  );

  const read = () => {
    switch (status) {
      case "pending":
        // Promiseì˜ ìƒíƒœê°€ settled ë˜ì§€ ì•Šì•˜ì„ ë•Œ ê·¸ëŒ€ë¡œ throw Promise
        throw suspender;
      case "error":
        // Promiseì˜ ìƒíƒœê°€ reject ë˜ì—ˆì„ ë•Œ throw response(error)
        throw response;
      default:
        // ì„±ê³µ ì‹œ ë°ì´í„° ë°˜í™˜
        return response;
    }
  };

  return { read };
}

export default function fetchData(url) {
  const promise = fetch(url)
    .then((res) => {
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      return res.json();
    })
    .then((res) => res)
    .catch((err) => {
      throw err;
    });

  return wrapPromise(promise);
}
```

```js
// App.js

import fetchData from "./fetchData";

const resource = fetchData("https://jsonplaceholder.typicode.com/todos");

function DataComponent() {
  const todos = resource.read();

  console.log(todos);

  return <div>Data Component</div>;
}

export default function App() {
  return (
    <ErrorBoundary fallback={<h1>Error!</h1>}>
      <Suspense fallback={<h1>Loading...</h1>}>
        <DataComponent />
      </Suspense>
    </ErrorBoundary>
  );
}
```

ë‚´ë¶€ ë™ì‘ì„ ì¢€ ë” ì´í•´í•˜ê¸° ìœ„í•´ Suspenseë¥¼ ì§ì ‘ êµ¬í˜„í•´ë³´ì.  
ErrorBoundaryì™€ ë§ˆì°¬ê°€ì§€ë¡œ í•˜ìœ„ì—ì„œì˜ throwë¥¼ catchí•˜ê¸° ìœ„í•´ í´ë˜ìŠ¤ ì»´í¬ë„ŒíŠ¸ë¡œì˜ êµ¬í˜„ì´ í•„ìš”í•˜ë‹¤.

```js
// Suspense.js

import React from "react";

export default class Suspense extends React.Component {
  constructor(props) {
    super(props);

    this.state = {
      pending: false,
      error: undefined,
    };
  }

  // Catch Promise!
  componentDidCatch(catchedPromise) {
    if (catchedPromise && typeof catchedPromise.then === "function") {
      this.setState({ pending: true });

      catchedPromise
        .then(() => {
          this.setState({ pending: false });
        })
        .catch((err) => {
          this.setState({ error: err || new Error("Unexpected Error") });
        });
    } else {
      throw catchedPromise;
    }
  }

  componentDidUpdate() {
    if (this.state.pending && this.state.error) {
      throw this.state.error;
    }
  }

  render() {
    return this.state.pending ? this.props.fallback : this.props.children;
  }
}
```

<br />

ì •ìƒì ì¸ ë¡œë”© í”„ë¡œì„¸ìŠ¤ì˜ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì„ ê±°ì¹œë‹¤.

```
Suspense:         pending: false                           pending: true ---------------------> pending: false
                      |                                        ^                                         |
                      v                                        |                                         v
DataComponent:      render --------------> read() ---> throw Promise                                 read() ----> data

```

ì¦‰, **ì‹¤í–‰ -> api ìš”ì²­ -> ë¡œë”©(fallback) -> ì¬ì‹¤í–‰**ì˜ ê³¼ì •ì„ ê±°ì¹œë‹¤.

ì´ì™€ ê°™ì€ ë°©ì‹ì„ `render as you fetch`, ì§ì—­í•˜ë©´ "ê°€ì ¸ì˜¤ëŠ” ëŒ€ë¡œ ë Œë”ë§" ì´ë¼ëŠ” ëœ»ì´ë‹¤.  
ì»´í¬ë„ŒíŠ¸ê°€ ì‹¤í–‰ë˜ê³  fetchê°€ ì™„ë£Œë˜ëŠ” ëŒ€ë¡œ í•´ë‹¹ ë°ì´í„°ë¥¼ ë Œë”ë§í•˜ëŠ” ì´ ê³¼ì •ì„ ì´í•´í•˜ê³  ë³´ë‹ˆ ì˜ë¯¸ê°€ ë” ì™€ë‹¿ëŠ”ë‹¤.

---

## â—Suspense ì‚¬ìš© ì‹œ ì£¼ì˜í•  ì 

ë‹¤ì‹œ ì£¼ì œë¡œ ëŒì•„ì™€ì„œ Suspenseì˜ ì‚¬ìš©ì´ í•­ìƒ ì˜³ì€ì§€ì— ëŒ€í•´ ê²€í† í•´ë³´ì.

### 1. ë¦¬ë Œë”ë§

Suspenseì™€ ë°ì´í„°ë¥¼ fetchí•˜ëŠ” ì»´í¬ë„ŒíŠ¸ ì‚¬ì´ì˜ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ëŠ” "ì¬ì‹¤í–‰" ê³¼ì •ì—ì„œ ëª¨ë‘ ë¦¬ë Œë”ë§ëœë‹¤.

```jsx
return (
  <>
    <Suspense>
      <Wrapper1>
        <Wrapper2>
          <DataComponent />
        </Wrapper2>
      </Wrapper1>
    </Suspense>
  </>
);

function Wrapper1({ children }) {
  console.log("hi, I'm Wrapper1");
  return <>{children}</>;
}

function Wrapper2({ children }) {
  console.log("hi, I'm Wrapper2");
  return <>{children}</>;
}
```

ìœ„ ì½”ë“œëŠ” ì½˜ì†”ì— ë‹¤ìŒê³¼ ê°™ì´ ì°íŒë‹¤.

```
hi, I'm Wrapper1
hi, I'm Wrapper2

# api í˜¸ì¶œ ì™„ë£Œ í›„ ì¬ì‹¤í–‰

hi, I'm Wrapper1
hi, I'm Wrapper2
```

api ìš”ì²­ì´ ì™„ë£Œë˜ê³  Suspenseì˜ `render()` ê°€ ë‹¤ì‹œ í˜¸ì¶œë˜ë©´ì„œ Suspense í•˜ìœ„ì˜ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ëŠ” ë¦¬ë Œë”ë§ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```js
// Suspense.js

render() {
  return this.state.pending ? this.props.fallback : this.props.children;
}
```

ì´ ê³¼ì •ì—ì„œ ë°ì´í„°ì™€ ë¬´ê´€í•œ ì»´í¬ë„ŒíŠ¸ë„ ë¦¬ë Œë”ë§ë  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ ë¬¸ì œì´ë‹¤.  
ì´ë¥¼ ë°©ì§€í•˜ë ¤ë©´ Suspenseì™€ DataComponent ê°„ì˜ ê³„ì¸µì„ ìµœëŒ€í•œ ì¢í˜€ì•¼ í•œë‹¤.

### 2. waterfall

í•˜ë‚˜ì˜ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë‘ ê°œì˜ api í˜¸ì¶œì„ í•˜ëŠ” ê²½ìš°ë¥¼ ê°€ì •í•´ë³´ì.

```jsx
import fetchData from "./fetchData";

const todoResource = fetchData("https://jsonplaceholder.typicode.com/todos2");
const postResource = fetchData("https://jsonplaceholder.typicode.com/todos2");

export default function DataComponent() {
  const todos = todoResource.read();
  const posts = postResource.read();

  return <div>Data Component</div>;
}
```

ì•ì„œ Suspense ë‚´ë¶€ ë™ì‘ì— ë”°ë¼ ìœ„ ì»´í¬ë„ŒíŠ¸ì˜ ë™ì‘ì„ ìœ ì¶”í•´ë³´ë©´  
ë¨¼ì € todoì— ëŒ€í•œ api ìš”ì²­ì´ ì§„í–‰ë˜ê³ , Promiseë¥¼ throwí•œë‹¤.  
í•´ë‹¹ ì‘ì—…ì´ ì™„ë£Œë˜ë©´, ë‹¤ì‹œ postì— ëŒ€í•œ Promiseë¥¼ throwí•œë‹¤.

ë•Œë¬¸ì— api ìš”ì²­ì´ ë³‘ë ¬ë¡œ ì§„í–‰ë˜ì§€ ì•Šê³ , waterfallì´ ë°œìƒí•œë‹¤.  
![](/images/2024-12-03-suspense/image.png)

#### ğŸ¤” How to Solve?

1. í•˜ë‚˜ì˜ ì»´í¬ë„ŒíŠ¸ì—ì„œ í•˜ë‚˜ì˜ api ìš”ì²­ì´ ì¼ì–´ë‚˜ë„ë¡ ë¶„ë¦¬í•œë‹¤.

   ```jsx
   return (
     <>
       <Suspense>
         <TodoComponent />
       </Suspense>

       <Suspense>
         <PostComponent />
       </Suspense>
     </>
   );
   ```

2. `Promise.all` í˜¹ì€ `useSuspenseQueries`ë¥¼ ì‚¬ìš©í•œë‹¤.

   ```jsx
   // Promise.all ì‚¬ìš©

   export default function DataComponent() {
     const { data } = useSuspenseQuery({
       queryKey: ["todos", "posts"],
       queryFn: async () => {
         const [{ data: todos }, { data: posts }] = await Promise.all([
           getTodos(),
           getPosts(),
         ]);

         return { todos, posts };
       },
     });

     return <div>Data Component</div>;
   }
   ```

   ```jsx
   // useSuspenseQueries ì‚¬ìš©

   export default function DataComponent() {
     const [{ data: todos }, { data: posts }] = useSuspenseQueries({
       queries: [
         {
           queryKey: ["todos"],
           queryFn: () => getTodos(),
         },
         {
           queryKey: ["posts"],
           queryFn: () => getPosts(),
         },
       ],
     });

     return <div>Data Component</div>;
   }
   ```

### 3. ìˆœì„œ ë³´ì¥ x

ì»´í¬ë„ŒíŠ¸ì—ì„œ api ìš”ì²­ì´ ê°ê° ì´ë¤„ì§ˆ ê²½ìš° ë¡œë“œë˜ëŠ” ìˆœì„œê°€ ë³´ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤.

```jsx
return (
  <>
    <Suspense fallback={<h1>Loading user details</h1>}>
      <UserProfile />
    </Suspense>

    <Suspense fallback={<h1>Loading Todos</h1>}>
      <TodoComponent />
    </Suspense>
  </>
);
```

ì•„ë˜ ì´ë¯¸ì§€ì˜ ê²½ìš° ìœ ì €ì— ëŒ€í•œ ë°ì´í„°ë³´ë‹¤ todoì— ëŒ€í•œ ë°ì´í„°ê°€ ë¨¼ì € ë‚˜ì˜¨ë‹¤.  
ì´ëŠ” ì‚¬ìš©ìê°€ ì–´ìƒ‰í•¨ì„ ëŠë‚„ ìˆ˜ ìˆëŠ” ìš”ì¸ì´ ëœë‹¤.

![](/images/2024-12-03-suspense/image2.gif)

#### ğŸ¤” How to Solve?

1. ìˆœì°¨ì ìœ¼ë¡œ ë¡œë”©

   ```jsx
   return (
     <>
       <Suspense fallback={<h1>Loading user details</h1>}>
         <UserProfile />

         <Suspense fallback={<h1>Loading Todos</h1>}>
           <TodoComponent />
         </Suspense>
       </Suspense>
     </>
   );
   ```

2. í•˜ë‚˜ì˜ Suspenseë¡œ ê´€ë¦¬

   ```jsx
   return (
     <Suspense fallback={<h1>Loading...</h1>}>
       <UserProfile />
       <TodoComponent />
     </Suspense>
   );
   ```

### 4. ê¹œë¹¡ì„

ë¡œë”©ì„ UIë¡œ ì•Œë¦¬ëŠ” ê²½ìš°, ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì†ë„ê°€ ë„ˆë¬´ ë¹¨ë¼ ìƒê¸°ëŠ” ê¹œë¹¡ì„ í˜„ìƒì´ ì¡´ì¬í•œë‹¤.

![alt text](/images/2024-12-03-suspense/image4.gif)

#### ğŸ¤” How to Solve?

state ì—…ë°ì´íŠ¸ì˜ ìš°ì„ ìˆœìœ„ë¥¼ ë‚®ì¶”ëŠ” `useDefferedValue` / `startTransition`ì„ í†µí•´ ì´ë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

##### useDefferedValue

```jsx
// App.jsx

export default function App() {
  const [keyword, setKeyword] = useState("");

  const handleChange = (e) => {
    setKeyword(e.target.value);
  };

  return (
    <>
      <input type="text" value={keyword} onChange={handleChange} />

      <Suspense fallback={<h1>Loading...</h1>}>
        <DataComponent keyword={keyword} />
      </Suspense>
    </>
  );
}
```

```jsx
// DataComponent.jsx

export default function DataComponent({ keyword }) {
  const deferredKeyword = useDeferredValue(keyword);
  const { data } = useSuspenseQuery({
    queryKey: ["data", deferredKeyword],
    queryFn: () => getProductList(deferredKeyword),
  });

  if (data?.list.length === 0) return <span>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>;

  return (
    <ul>
      {data?.list.map((each) => (
        <li key={each.id}>{each.name}</li>
      ))}
    </ul>
  );
}
```

ìœ„ ì½”ë“œì—ì„œ inputì˜ valueëŠ” ì¦‰ê°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì§€ë§Œ,  
DataComponent ë‚´ë¶€ì—ì„œëŠ” ë¹„ë™ê¸° ì‘ì—…ì´ ì™„ë£Œë˜ê¸° ì „ê¹Œì§€ Promiseë¥¼ throwí•˜ì§€ ì•ŠëŠ”ë‹¤.

![alt text](/images/2024-12-03-suspense/image3.png)

---

## ê²°ë¡ : ë¦¬ì•¡íŠ¸ì—ì„œì˜ ë¡œë”© ì²˜ë¦¬

Suspenseì˜ ë‚´ë¶€ ë™ì‘ ì›ë¦¬ë¥¼ ì´í•´í•¨ìœ¼ë¡œì¨ ë°œìƒí•˜ëŠ” ë¬¸ì œë“¤ì„ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤.  
ìƒíƒœë¥¼ í•˜ë‚˜ë¼ë„ ì¤„ì´ê³  ì±…ì„ì„ ë¶„ë¦¬í•˜ëŠ” ì¸¡ë©´ì—ì„œ ë‹¨ì ë³´ë‹¤ëŠ” ì¥ì ì´ ë” ë§ë‹¤ê³  ëŠê»´ì¡Œë‹¤.  
"í•­ìƒ ì˜³ì€ê°€?"ë¼ëŠ” ì§ˆë¬¸ì— ëŒ€í•œ ë‹µì€, "ì—¬ê±´ì´ ëœë‹¤ë©´ ê·¸ë ‡ë‹¤" ë¼ê³  ê²°ë¡ ì§€ì—ˆë‹¤.

<br />

Suspenseë¥¼ ê³µë¶€í•˜ë©´ì„œ ë¦¬ì•¡íŠ¸ì—ì„œì˜ ë¡œë”© ì²˜ë¦¬ì— ëŒ€í•´ ê³ ë¯¼í•´ë³¼ ìˆ˜ ìˆëŠ” ì‹œê°„ì´ì—ˆê³ , ì‚¬ìš©í•´ ë³¸ ëª¨ë“  ë¡œë”© ì²˜ë¦¬ì™€ ë¬¸ì œì ì„ ì •ë¦¬í•´ë´¤ë‹¤.

| ë¡œë”© ì²˜ë¦¬                    | ë¬¸ì œì                                                      |
| ---------------------------- | ---------------------------------------------------------- |
| ì•„ë¬´ëŸ° ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•ŠëŠ” ê²½ìš° | CLS ë°œìƒ                                                   |
| Spinner                      | ê¹œë¹¡ì„ ë¬¸ì œ                                                |
| ìŠ¤ì¼ˆë ˆí†¤                     | ê¹œë¹¡ì„ ë¬¸ì œ, ë¹„ìš©                                          |
| ì´ì „ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ëŠ” ë°©ì‹  | ì‘ë‹µì´ ë„ˆë¬´ ëŠë¦¬ë©´ ìƒí˜¸ì‘ìš©ì´ ì•„ì˜ˆ ì•ˆëœë‹¤ê³  íŒë‹¨ë  ìˆ˜ ìˆìŒ |

ì •ë¦¬í•´ë³´ìë©´, í˜„ì¬ê¹Œì§€ì˜ ê²½í—˜ìœ¼ë¡œ ê°€ì¥ ì™„ë²½í•œ ë¡œë”© ì²˜ë¦¬ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:

- ìŠ¤ì¼ˆë ˆí†¤
- ì‚¬ìš©ìì˜ ìƒí˜¸ì‘ìš©ì— ì˜í•œ ë¡œë”© ì‹œ ì´ì „ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ëŠ” ë°©ì‹ ì‚¬ìš© (`useDeferredValue`ë‚˜ `placeholderData: keepPreviousData`)
  - ë§Œì•½ ì‘ë‹µ ì‹œê°„ì´ ë„ˆë¬´ ê¸¸ë‹¤ë©´, ìŠ¤ì¼ˆë ˆí†¤ìœ¼ë¡œ ëŒ€ì²´

---

## ì°¸ê³ ìë£Œ

- https://velog.io/@seungchan__y/React-18-Concurrent-%EB%A7%9B%EB%B3%B4%EA%B8%B0
- https://blog.logrocket.com/data-fetching-react-suspense/
- https://happysisyphe.tistory.com/54
